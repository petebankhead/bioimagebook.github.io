
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Morphological operations &#8212; Introduction to Bioimage Analysis</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mycss.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/togglebutton.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="ImageJ: Morphological operations" href="imagej.html" />
    <link rel="prev" title="ImageJ: Filters" href="../4-filters/imagej.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<script defer data-domain="bioimagebook.github.io" src="https://plausible.io/js/plausible.js"></script>
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../../_static/book-logo-smaller.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Introduction to Bioimage Analysis</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../README.html">
                    Introduction to Bioimage Analysis
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Front matter
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../0-preamble/acknowledgements/acknowledgements.html">
   Acknowledgements
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../0-preamble/license.html">
   License
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../0-preamble/disclaimer.html">
   Disclaimer
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Before we begin
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../0-preamble/preface/preface.html">
   Preface
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../0-preamble/reading/reading.html">
   How to read this book
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Introducing images
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../1-concepts/1-images_and_pixels/images_and_pixels.html">
   Images &amp; pixels
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../1-concepts/1-images_and_pixels/imagej.html">
     ImageJ: Images &amp; pixels
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../1-concepts/1-images_and_pixels/python.html">
     Python: Images &amp; pixels
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../1-concepts/2-measurements/measurements.html">
   Measurements &amp; histograms
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../1-concepts/2-measurements/imagej.html">
     ImageJ: Measurements &amp; histograms
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../1-concepts/2-measurements/python.html">
     Python: Measurements &amp; histograms
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../1-concepts/3-bit_depths/bit_depths.html">
   Types &amp; bit-depths
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../1-concepts/3-bit_depths/imagej.html">
     ImageJ: Types &amp; bit-depths
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../1-concepts/3-bit_depths/python.html">
     Python: Types &amp; bit-depths
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../1-concepts/4-colors/colors.html">
   Channels &amp; colors
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../1-concepts/4-colors/imagej.html">
     ImageJ: Channels &amp; colors
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../1-concepts/4-colors/python.html">
     Python: Channels &amp; colors
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../1-concepts/5-pixel_size/pixel_size.html">
   Pixel size &amp; dimensions
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../1-concepts/5-pixel_size/imagej.html">
     ImageJ:  Pixel size &amp; dimensions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../1-concepts/5-pixel_size/python.html">
     Python:  Pixel size &amp; dimensions
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../1-concepts/6-files/files.html">
   Files &amp; file formats
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../1-concepts/6-files/imagej.html">
     ImageJ: Files &amp; file formats
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../1-concepts/6-files/python.html">
     Python: Files &amp; file formats
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Processing &amp; analysis
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../1-processing_and_analysis/processing_and_analysis.html">
   Image processing &amp; analysis
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../2-point_operations/point_operations.html">
   Point operations
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../2-point_operations/imagej.html">
     ImageJ: Point operations
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../3-thresholding/thresholding.html">
   Thresholding
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../3-thresholding/imagej.html">
     ImageJ: Thresholding
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../4-filters/filters.html">
   Filters
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
  <label for="toctree-checkbox-9">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../4-filters/imagej.html">
     ImageJ: Filters
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="current reference internal" href="#">
   Morphological operations
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
  <label for="toctree-checkbox-10">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="imagej.html">
     ImageJ: Morphological operations
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../6-transforms/transforms.html">
   Image transforms
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
  <label for="toctree-checkbox-11">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../6-transforms/imagej.html">
     ImageJ: Image transforms
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../7-multidimensional_processing/multidimensional_processing.html">
   Multidimensional processing
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
  <label for="toctree-checkbox-12">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../7-multidimensional_processing/imagej.html">
     ImageJ: Multidimensional processing
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Fluorescence microscopy
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../3-fluorescence/1-formation_overview/formation_overview.html">
   From photons to pixels
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../3-fluorescence/2-formation_spatial/formation_spatial.html">
   Blur &amp; the PSF
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../3-fluorescence/3-formation_noise/formation_noise.html">
   Noise
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../3-fluorescence/4-microscope_types/microscope_types.html">
   Microscopes &amp; detectors
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Appendices
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../appendices/next_steps/next_steps.html">
   Beyond this book
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../appendices/python/python.html">
   Python Primer
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../appendices/macros/macro_intro.html">
   ImageJ: Writing macros
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
  <label for="toctree-checkbox-13">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../appendices/macros/macro_dog.html">
     Difference of Gaussians
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../appendices/macros/macro_simulating.html">
     Simulating image formation
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/bioimagebook/bioimagebook.github.io/main?urlpath=tree/chapters/2-processing/5-morph/morph.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        
<button onclick="initThebeSBT()"
  class="headerbtn headerbtn-launch-thebe"
  data-toggle="tooltip"
data-placement="left"
title="Launch Thebe"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="headerbtn__text-container">Live Code</span>
</button>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../../_sources/chapters/2-processing/5-morph/morph.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download notebook file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-code"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        <a href="../../../_sources/chapters/2-processing/5-morph/morph.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#morphological-operations-using-rank-filters">
   Morphological operations using rank filters
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#erosion-dilation">
     Erosion &amp; dilation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#opening-closing">
     Opening &amp; closing
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#boundaries-outlines">
     Boundaries &amp; outlines
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#finding-local-minima-maxima">
     Finding local minima &amp; maxima
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#more-morphological-operations">
   More morphological operations
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#area-opening">
     Area opening
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#filling-holes">
     Filling holes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#thinning-skeletonization">
     Thinning &amp; skeletonization
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#morphological-reconstruction">
   Morphological reconstruction
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#hysteresis-thresholding">
     Hysteresis thresholding
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#h-maxima-h-minima">
     H-Maxima &amp; H-Minima
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#opening-closing-by-reconstruction">
     Opening &amp; closing by reconstruction
    </a>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Morphological operations</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#morphological-operations-using-rank-filters">
   Morphological operations using rank filters
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#erosion-dilation">
     Erosion &amp; dilation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#opening-closing">
     Opening &amp; closing
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#boundaries-outlines">
     Boundaries &amp; outlines
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#finding-local-minima-maxima">
     Finding local minima &amp; maxima
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#more-morphological-operations">
   More morphological operations
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#area-opening">
     Area opening
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#filling-holes">
     Filling holes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#thinning-skeletonization">
     Thinning &amp; skeletonization
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#morphological-reconstruction">
   Morphological reconstruction
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#hysteresis-thresholding">
     Hysteresis thresholding
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#h-maxima-h-minima">
     H-Maxima &amp; H-Minima
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#opening-closing-by-reconstruction">
     Opening &amp; closing by reconstruction
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="morphological-operations">
<span id="chap-morph"></span><span id="chap-binary"></span><h1>Morphological operations<a class="headerlink" href="#morphological-operations" title="Permalink to this headline">#</a></h1>
<div class="tip admonition">
<p class="admonition-title">Chapter outline</p>
<ul class="simple">
<li><p><strong>Morphological operations</strong> can be used to refine or modify the shapes of objects in images</p></li>
<li><p>Many morphological operations can be applied to <strong>binary images</strong> to improve an image segmentation</p></li>
<li><p><strong>Grayscale morphological operations</strong> can also be used as processing steps before binarization, or to help identify regional maxima and minima</p></li>
</ul>
</div>
<div class="cell tag_hide-cell tag_thebe-init docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%load_ext autoreload
%autoreload 2

# Default imports
import sys
sys.path.append(&#39;../../../&#39;)
from helpers import *
from matplotlib import pyplot as plt
from myst_nb import glue
import numpy as np
from scipy import ndimage
</pre></div>
</div>
</div>
</div>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">#</a></h2>
<p>Image filters and thresholds enable us to detect structures of various shapes and sizes for different applications.
Nevertheless, despite our best efforts, the binary images produced by our thresholds often still contain inaccurate or undesirable detected regions.
They could benefit from some extra cleaning up.</p>
<p>At this stage, we are primarily working with shapes – morphology – so most of the techniques we describe here are often called <strong>morphological operations</strong>.</p>
</section>
<section id="morphological-operations-using-rank-filters">
<h2>Morphological operations using rank filters<a class="headerlink" href="#morphological-operations-using-rank-filters" title="Permalink to this headline">#</a></h2>
<div class="cell tag_hide-cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>&quot;&quot;&quot;
Show morphological operations.

Note that, as a habit, I use &#39;bw_&#39; at the beginning of variable names for
variables that are really binary (black/white) images to identify these
from other images, for which I use &#39;im_&#39;.
&quot;&quot;&quot;

def create_disk(radius: int):
    &quot;&quot;&quot;
    Create a circular structuring element.
    This is essentially the binary/morphological equivalent the filter kernel.
    &quot;&quot;&quot;
    r = radius
    x = np.arange(-r, r+1)
    y = np.arange(-r, r+1)
    y, x = np.meshgrid(x, x)
    return x*x + y*y &lt;= r*r

# Create structuring element
radius = 2
strel = create_disk(radius)

# Erode, dilate, open &amp; close the corresponding images
# Use &gt; 0 when reading to ensure they are binary (&#39;bool&#39;) arrays,
# not 8-bit images that happen to just have two values in them.
bw_erode = load_image(&#39;images/morph_erode.png&#39;) &gt; 0
bw_eroded = ndimage.binary_erosion(bw_erode, structure=strel)

bw_dilate = load_image(&#39;images/morph_dilate.png&#39;) &gt; 0
bw_dilated = ndimage.binary_dilation(bw_dilate, structure=strel)

bw_open = load_image(&#39;images/morph_open.png&#39;) &gt; 0
bw_opened = ndimage.binary_opening(bw_open, structure=strel)

bw_close = load_image(&#39;images/morph_close.png&#39;) &gt; 0
bw_closed = ndimage.binary_closing(bw_close, structure=strel)

# Show original concatenated with the filtered images
fig = create_figure(figsize=(8, 4))

show_image(np.vstack((bw_erode, bw_eroded)), title=&quot;(A) Erosion&quot;, pos=141)
show_image(np.vstack((bw_dilate, bw_dilated)), title=&quot;(B) Dilation&quot;, pos=142)
show_image(np.vstack((bw_open, bw_opened)), title=&quot;(C) Opening&quot;, pos=143)
show_image(np.vstack((bw_close, bw_closed)), title=&quot;(D) Closing&quot;, pos=144)
glue_fig(&#39;fig_erode_dilate_open&#39;, fig)
</pre></div>
</div>
</div>
</div>
<figure class="align-center" id="fig-erode-dilate-open">
<div class="cell_output docutils container">
<img alt="../../../_images/morph_4_0.png" src="../../../_images/morph_4_0.png" />
</div>
<figcaption>
<p><span class="caption-number">Fig. 100 </span><span class="caption-text">Overview of erosion, dilation, opening and closing.
The original image is shown at the top, while the processed part is at the bottom in each case.</span><a class="headerlink" href="#fig-erode-dilate-open" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<section id="erosion-dilation">
<h3>Erosion &amp; dilation<a class="headerlink" href="#erosion-dilation" title="Permalink to this headline">#</a></h3>
<p>Our first two morphological operations, <strong>erosion</strong> and <strong>dilation</strong>, are actually identical to minimum and maximum filtering respectively, described <a class="reference internal" href="../4-filters/filters.html#sec-filters-rank"><span class="std std-ref">in the previous chapter</span></a>.
The names erosion and dilation are used more often when speaking of binary images, but the operations are the same irrespective of the kind of image.</p>
<div class="admonition-structuring-elements admonition">
<p class="admonition-title">Structuring elements</p>
<p>The neighborhood used to calculate the result for each pixel is defined by a <strong>structuring element</strong>.
This is similar to a <a class="reference internal" href="../4-filters/filters.html#sec-filters-linear"><span class="std std-ref">filter kernel</span></a>, except that it only has values 0 and 1 (for ignoring or including the neighborhood pixel, respectively).</p>
</div>
<aside class="margin sidebar">
<p class="sidebar-title"></p>
<p>Here, we assume the background value in our binary image is 0 (black) and foreground is 1 (white).</p>
</aside>
<p><strong>Erosion</strong> will make objects in the binary image smaller, because a pixel will be set to the background value if <em>any</em> other pixels in the neighborhood are background.
This can split single objects into multiple pieces.</p>
<p>Conversely, <strong>dilation</strong> makes objects bigger, since the presence of a single foreground pixel anywhere in the neighborhood will result in a foreground output.
This can also cause objects to merge.</p>
<div class="cell tag_hide-cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def load_spots() -&gt; np.ndarray:
    im = load_image(&#39;hela-cells.zip&#39;)[50:400, 50:450, 0].astype(np.float32)
    return im

def load_binary_spots(method=&#39;median&#39;) -&gt; np.ndarray:
    &quot;&quot;&quot;
    Create a small, imperfect binary image containing spots.
    We don&#39;t try to optimize preprocessing or thresholds - we just want something for illustration.
    &quot;&quot;&quot;
    import skimage.filters as filters
    import skimage.morphology as morph

    im = load_spots()
    if method == &#39;median&#39;:
        im_bg = ndimage.median_filter(im, (15, 15))
        im = im - im_bg
    elif method == &#39;opening&#39;:
        im_bg = morph.opening(im, morph.disk(10))
        im = im - im_bg
    elif method == &#39;dog&#39;:
        sigma = 2.5
        im = filters.gaussian(im, sigma) - filters.gaussian(im, sigma*1.6)
    bw = im &gt; filters.threshold_triangle(im)
    return bw

# Define radius (change this to update the figure!)
radius = 2

# Create structuring element
strel = create_disk(radius)

# Load image &amp; process
bw = load_binary_spots()
bw_eroded = ndimage.binary_erosion(bw, structure=strel)
bw_dilated = ndimage.binary_dilation(bw, structure=strel)

# Show original concatenated with the filtered images
fig = create_figure(figsize=(8, 8))

show_image(bw, title=&quot;(A) Binary image&quot;, pos=131)
show_image(bw_eroded, title=f&quot;(B) Erosion (radius={radius})&quot;, pos=132)
show_image(bw_dilated, title=f&quot;(C) Dilation (radius={radius})&quot;, pos=133)
plt.tight_layout()
glue_fig(&#39;fig_erode_dilate_spots&#39;, fig)
</pre></div>
</div>
</div>
</div>
<figure class="align-center" id="fig-erode-dilate-spots">
<div class="cell_output docutils container">
<img alt="../../../_images/morph_6_0.png" src="../../../_images/morph_6_0.png" />
</div>
<figcaption>
<p><span class="caption-number">Fig. 101 </span><span class="caption-text">The effects of erosion and dilation on a binary image of small structures.</span><a class="headerlink" href="#fig-erode-dilate-spots" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="opening-closing">
<span id="sec-morph-opening-closing"></span><h3>Opening &amp; closing<a class="headerlink" href="#opening-closing" title="Permalink to this headline">#</a></h3>
<p>The fact that erosion and dilation alone affect sizes can be a problem: we may like their abilities to merge, separate or remove objects, but prefer that they had less impact upon areas and volumes.
Combining both operations helps achieve this.</p>
<p><strong>Opening</strong> consists of an erosion followed by a dilation.
It therefore first shrinks objects, and then expands whatever remains to <em>approximately</em> its original size.</p>
<p>Such a process is not as pointless as it may first sound.
If erosion causes very small objects to completely disappear, clearly the dilation cannot make them reappear: they are gone for good.
Barely-connected objects separated by erosion are also not reconnected by the dilation step.</p>
<p><strong>Closing</strong> is the opposite of opening, i.e. a dilation followed by an erosion, and similarly changes the shapes of objects.
The dilation can cause almost-connected objects to merge, and these often then remain merged after the erosion step.
If you wish to count objects, but they are wrongly subdivided in the segmentation, closing may help make the counts more accurate.</p>
<div class="cell tag_hide-cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Define radius (change this to update the figure!)
radius = 2

# Create structuring element
strel = create_disk(radius)

# Load image &amp; process
bw = load_binary_spots()
bw_opened = ndimage.binary_opening(bw, structure=strel)
bw_closed = ndimage.binary_closing(bw, structure=strel)

# Show original concatenated with the filtered images
fig = create_figure(figsize=(8, 8))

show_image(bw, title=&quot;(A) Binary image&quot;, pos=131)
show_image(bw_opened, title=f&quot;(B) Opened (radius={radius})&quot;, pos=132)
show_image(bw_closed, title=f&quot;(C) Closed (radius={radius})&quot;, pos=133)
plt.tight_layout()

glue_fig(&#39;fig_open_close_spots&#39;, fig)
</pre></div>
</div>
</div>
</div>
<figure class="align-center" id="fig-open-close-spots">
<div class="cell_output docutils container">
<img alt="../../../_images/morph_9_0.png" src="../../../_images/morph_9_0.png" />
</div>
<figcaption>
<p><span class="caption-number">Fig. 102 </span><span class="caption-text">The effects of opening and closing on a binary image of small structures. Unlike when using erosion or dilation alone, the sizes of objects are largely preserved although the contours are modified. Opening has the effect of completely removing the smallest or thinnest objects.</span><a class="headerlink" href="#fig-open-close-spots" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="boundaries-outlines">
<h3>Boundaries &amp; outlines<a class="headerlink" href="#boundaries-outlines" title="Permalink to this headline">#</a></h3>
<p>We can make use of the operations above to identify outlines in a binary image.
To do this, we first need a clear definition of what we mean by ‘outline’.</p>
<p>The <strong>inner boundary</strong> may be defined as <em>the foreground pixels that are adjacent to background pixels</em>.
We can determine the inner boundary by</p>
<ul class="simple">
<li><p>Duplicating the binary image</p></li>
<li><p>Eroding with a 3×3 structuring element</p></li>
<li><p>Subtracting the eroded image from the original</p></li>
</ul>
<p>The <strong>outer boundary</strong> may be defined as <em>the background pixels that are adjacent to foreground pixels</em>.
We can determine the outer boundary by</p>
<ul class="simple">
<li><p>Duplicating the binary image</p></li>
<li><p>Dilating with a 3×3 structuring element</p></li>
<li><p>Subtracting the original image from the dilated image</p></li>
</ul>
<div class="tip admonition">
<p class="admonition-title">Thicker boundaries</p>
<p>There’s no reason to limit outlines to being 1 pixel thick.
Choosing a larger structuring element makes it possible create thicker outlines.
We might also subtract an eroded image from a dilated image to identify a thicker boundary that contains both inner and outer pixels.</p>
<p>One application of creating thick boundaries in microscopy images of cells is to generate a binary image of the nuclei, and then a second binary image representing a ring around the nucleus.
This makes it possible to make measurements that are likely to be within the cytoplasm, just outside the nucleus, without the task of identifying the full area of the cell – which is often difficult if the cell or membrane are not clearly visible.</p>
</div>
<div class="cell tag_hide-cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Define radius (change this to update the figure!)
radius = 3

# Create structuring element
strel = create_disk(radius)

# Load image &amp; process
bw = load_binary_spots()
bw_eroded = ndimage.binary_erosion(bw, structure=strel)
bw_dilated = ndimage.binary_dilation(bw, structure=strel)

# Show original concatenated with the filtered images
fig = create_figure(figsize=(8, 8))

show_image(bw, title=&quot;(A) Binary image&quot;, pos=131)
show_image(bw ^ bw_eroded, title=f&quot;(B) Inner boundaries (radius={radius})&quot;, pos=132)
show_image(bw_dilated ^ bw, title=f&quot;(C) Outer boundaries (radius={radius})&quot;, pos=133)
plt.tight_layout()

glue_fig(&#39;fig_binary_outlines&#39;, fig)
</pre></div>
</div>
</div>
</div>
<figure class="align-center" id="fig-binary-outlines">
<div class="cell_output docutils container">
<img alt="../../../_images/morph_12_0.png" src="../../../_images/morph_12_0.png" />
</div>
<figcaption>
<p><span class="caption-number">Fig. 103 </span><span class="caption-text">Calculating inner and outer boundaries, using erosion or dilation. The radius of the structuring element can be used to tune the boundary thickness.</span><a class="headerlink" href="#fig-binary-outlines" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="finding-local-minima-maxima">
<h3>Finding local minima &amp; maxima<a class="headerlink" href="#finding-local-minima-maxima" title="Permalink to this headline">#</a></h3>
<p>Erosion and dilation can be used to find pixels that are <strong>local maxima</strong> or <strong>local minima</strong> very easily, with the caveat that the results are inexact and often unusable.
Nevertheless, the trick works ‘well enough’ sufficiently often to be worth knowing.</p>
<p>Here, we focus on maxima; the process for detecting local minima is identical, except that either the image should be inverted or erosion used instead of dilation.</p>
<p>A local maximum can be defined as a pixel with a value greater than all its neighbors, or a connected group of pixels with the same higher value than the surrounding pixels.
An easy way to detect these pixels is to dilate the image with 3×3 maximum filter, and check for pixel values that are unchanged (i.e. where the pixel was already a maximum within its neighborhood).</p>
<p>This is inexact because it does not <em>only</em> identify maxima; it also detections some ‘plateaus’ where pixels have identical values to their neighbors.
In practice, this is not always a problem because noise can make plateaus virtually non-existent for many real-world images (at least ones that haven’t been clipped).</p>
<p>A bigger problem is that the approach often identifies far too many maxima to be useful (<a class="reference internal" href="#fig-morph-simple-maxima"><span class="std std-numref">Fig. 104</span></a>).</p>
<div class="cell tag_hide-cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from skimage import morphology as morph
from skimage import filters as filters
from skimage.segmentation import mark_boundaries

# Load image &amp; process
im = load_spots()
im_dilated = ndimage.maximum_filter(im, (3, 3))
bw = im == im_dilated
im2 = im - np.percentile(im.ravel(), 0.5)
im2 = im2 / np.percentile(im2.ravel(), 99.5)
im_boundaries = mark_boundaries(np.clip(im2, 0, 1), bw, color=(1, 0, 0))

# Show original concatenated with the filtered images
fig = create_figure(figsize=(8, 8))

show_image(im, clip_percentile=0.5, title=&quot;(A) Grayscale image&quot;, pos=221)
show_image(im_dilated, title=f&quot;(B) 3×3 dilation of (A)&quot;, pos=222)
show_image(bw, title=f&quot;(C) Pseudo-maxima where (A) == (B)&quot;, pos=223)
show_image(im_boundaries, title=f&quot;(C) Overlay of pseudo maxima&quot;, pos=224)
plt.tight_layout()

glue_fig(&#39;fig_morph_simple_maxima&#39;, fig)
</pre></div>
</div>
</div>
</div>
<figure class="align-center" id="fig-morph-simple-maxima">
<div class="cell_output docutils container">
<img alt="../../../_images/morph_15_0.png" src="../../../_images/morph_15_0.png" />
</div>
<figcaption>
<p><span class="caption-number">Fig. 104 </span><span class="caption-text">Identifying local maxima with the help of a 3×3 dilation tends to find too many maxima to be useful.</span><a class="headerlink" href="#fig-morph-simple-maxima" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>We can reduce these by either increasing the size of the maximum filter (therefore requiring pixels to be maximal across a larger region), or by pre-smoothing the image (usually with a <a class="reference internal" href="../4-filters/filters.html#sec-filters-gaussian"><span class="std std-ref">Gaussian filter</span></a>).
However, tuning the parameters becomes difficult.</p>
<p>We will see an alternative approach that is often more intuitive in <a class="reference internal" href="#sec-h-extrema"><span class="std std-ref">H-Maxima &amp; H-Minima</span></a>.</p>
<div class="cell tag_hide-cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Show original concatenated with the filtered images
fig = create_figure(figsize=(8, 8))

# Load image &amp; process
im = load_spots()
im_dilated = ndimage.maximum_filter(im, (7, 7))
bw = im == im_dilated
im2 = im - np.percentile(im.ravel(), 0.5)
im2 = im2 / np.percentile(im2.ravel(), 99.5)
im_boundaries = mark_boundaries(np.clip(im2, 0, 1), bw, color=(1, 0, 0))

show_image(im, clip_percentile=0.5, title=&quot;(A) Grayscale image&quot;, pos=221)
show_image(im_dilated, title=f&quot;(B) 7×7 dilation of (A)&quot;, pos=222)
show_image(bw, title=f&quot;(C) Pseudo-maxima where (A) == (B)&quot;, pos=223)
show_image(im_boundaries, title=f&quot;(C) Overlay of pseudo maxima&quot;, pos=224)
plt.tight_layout()

glue_fig(&#39;fig_morph_simple_maxima_bigger&#39;, fig)
</pre></div>
</div>
</div>
</div>
<figure class="align-center" id="fig-morph-simple-maxima-bigger">
<div class="cell_output docutils container">
<img alt="../../../_images/morph_17_0.png" src="../../../_images/morph_17_0.png" />
</div>
<figcaption>
<p><span class="caption-number">Fig. 105 </span><span class="caption-text">Identifying local maxima with the help of a larger dilation (here, 7×7 pixels) can sometimes give better results than using a smaller dilation <a class="reference internal" href="#fig-morph-simple-maxima"><span class="std std-numref">Fig. 104</span></a>.</span><a class="headerlink" href="#fig-morph-simple-maxima-bigger" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</section>
</section>
<section id="more-morphological-operations">
<h2>More morphological operations<a class="headerlink" href="#more-morphological-operations" title="Permalink to this headline">#</a></h2>
<section id="area-opening">
<h3>Area opening<a class="headerlink" href="#area-opening" title="Permalink to this headline">#</a></h3>
<p><strong>Area opening</strong> is similar to <em>opening</em>, except it avoids the need for any kind of maximum or minimum filtering.</p>
<p>It works by identifying <a class="reference internal" href="../3-thresholding/thresholding.html#sec-binary-labeled"><span class="std std-ref"><strong>connected components</strong> in the binary image</span></a>, which are contiguous regions of foreground pixels.
For each connected component, the number of pixels is counted to give an area in px².
If the area of a component falls below a specified area threshold, the pixels for that component are set to the background, i.e. the component is removed.</p>
<p><em>Area opening</em> is often preferable to <em>opening</em>, because it has <em>no impact</em> on the shape of any structures larger than the area threshold.
It simply applies a minimum area threshold, removing everything smaller.</p>
<div class="cell tag_hide-cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Define areas (change this to update the figure!)
small_area = 10
large_area = 100

from skimage import morphology as morph

# Load image &amp; process
bw = load_binary_spots()
bw_small_opened = morph.area_opening(bw, small_area)
bw_large_opened = morph.area_opening(bw, large_area)

# Show original concatenated with the filtered images
fig = create_figure(figsize=(8, 8))

show_image(bw, title=&quot;(A) Binary image&quot;, pos=131)
show_image(bw_small_opened, title=f&quot;(B) Small area opening ({small_area} px²)&quot;, pos=132)
show_image(bw_large_opened, title=f&quot;(C) Large area opening ({large_area} px²)&quot;, pos=133)
plt.tight_layout()

glue_fig(&#39;fig_area_open_spots&#39;, fig)
</pre></div>
</div>
</div>
</div>
<figure class="align-center" id="fig-area-open-spots">
<div class="cell_output docutils container">
<img alt="../../../_images/morph_19_0.png" src="../../../_images/morph_19_0.png" />
</div>
<figcaption>
<p><span class="caption-number">Fig. 106 </span><span class="caption-text">Using area opening to remove small objects.</span><a class="headerlink" href="#fig-area-open-spots" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="filling-holes">
<h3>Filling holes<a class="headerlink" href="#filling-holes" title="Permalink to this headline">#</a></h3>
<p><strong>Filling holes</strong> involves identifying connected components of <em>background pixels</em> that are entirely surrounded by foreground pixels.
These components are then ‘flipped’ to become foreground pixels instead.</p>
<p>Should we then want to identify the holes themselves, we can subtract the original image from the filled image.</p>
<div class="cell tag_hide-cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from skimage import morphology as morph

# Load image &amp; process
im = load_image(&#39;happy_cell.tif&#39;)
bw = im &gt; im.mean()
bw_filled = ndimage.binary_fill_holes(bw)

# Show original concatenated with the filtered images
fig = create_figure(figsize=(8, 8))

show_image(bw, title=&quot;(A) Binary image&quot;, pos=131)
show_image(bw_filled, title=f&quot;(B) Holes filled&quot;, pos=132)
show_image(bw_filled.astype(np.uint8) - bw.astype(np.uint8), title=f&quot;(C) Result of (B) - (A)&quot;, pos=133)
plt.tight_layout()

glue_fig(&#39;fig_fill_holes_cell&#39;, fig)
</pre></div>
</div>
</div>
</div>
<figure class="align-center" id="fig-fill-holes-cell">
<div class="cell_output docutils container">
<img alt="../../../_images/morph_22_0.png" src="../../../_images/morph_22_0.png" />
</div>
<figcaption>
<p><span class="caption-number">Fig. 107 </span><span class="caption-text">Filling holes in a binary image. Image subtraction makes it possible to extract the holes themselves.</span><a class="headerlink" href="#fig-fill-holes-cell" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<div class="cell tag_hide-cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Code to selective fill small holes

im = load_image(&#39;happy_cell.tif&#39;)
bw = im &gt; im.mean()

bw2 = ~bw
bw2 = morph.area_opening(bw2, 1000)
bw2 = ~bw2

fig = create_figure(figsize=(2, 2))
show_image(bw2)
glue_fig(&#39;fig_fill_small_holes_cell&#39;, fig)
</pre></div>
</div>
</div>
</div>
<figure class="margin align-default" id="id1">
<div class="cell_output docutils container">
<img alt="../../../_images/morph_24_0.png" src="../../../_images/morph_24_0.png" />
</div>
<figcaption>
<p><span class="caption-number">Fig. 108 </span><span class="caption-text">Small holes filled.</span><a class="headerlink" href="#id1" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<div class="sd-tab-set docutils">
<input checked="checked" id="018551c4-fdd9-4d35-afe6-56f9fe043cb6" name="b5abbba1-a7d9-4c7c-8dcb-f2ec39ac2350" type="radio">
</input><label class="sd-tab-label" for="018551c4-fdd9-4d35-afe6-56f9fe043cb6">
Question</label><div class="sd-tab-content docutils">
<p>We don’t always want to fill <em>all</em> the holes within a binary image, but rather only the smaller ones.
Can you think of a way to fill <em>only holes smaller than 1000 px²</em>, using area opening?</p>
<p>You’ll need at least one operation described in previous chapter.</p>
</div>
<input id="fbe574ce-d41e-4a7e-b026-fcb7c182097e" name="b5abbba1-a7d9-4c7c-8dcb-f2ec39ac2350" type="radio">
</input><label class="sd-tab-label" for="fbe574ce-d41e-4a7e-b026-fcb7c182097e">
Answer</label><div class="sd-tab-content docutils">
<p>One way to fill holes below a fixed size:</p>
<ul class="simple">
<li><p>Invert the binary image</p></li>
<li><p>Perform area opening with an area threshold of 1000 px²</p></li>
<li><p>Invert the result</p></li>
</ul>
</div>
</div>
</section>
<section id="thinning-skeletonization">
<h3>Thinning &amp; skeletonization<a class="headerlink" href="#thinning-skeletonization" title="Permalink to this headline">#</a></h3>
<p><strong>Thinning</strong> and <strong>skeletonization</strong> are related operations that aim to ‘thin down’ objects in a binary image to just their centerlines.
They are particularly useful with filamental or tube-like structures, such as axons or blood vessels.</p>
<div class="cell tag_hide-cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>im = load_image(&#39;happy_cell.tif&#39;)
bw = im &gt; im.mean()

bw = ndimage.binary_fill_holes(bw)
bw_thinned = morph.thin(bw)
bw_skeletonized = morph.skeletonize(bw)

# Show original concatenated with the filtered images
fig = create_figure(figsize=(8, 4))

show_image(bw, title=&quot;(A) Binary image&quot;, pos=131)
show_image(bw_thinned, title=&quot;(B) Thinned image&quot;, pos=132)
show_image(bw_skeletonized, title=&quot;(C) Skeletonized image&quot;, pos=133)

plt.tight_layout()
glue_fig(&#39;fig_binary_thinning&#39;, fig)
</pre></div>
</div>
</div>
</div>
<figure class="align-center" id="fig-binary-thinning">
<div class="cell_output docutils container">
<img alt="../../../_images/morph_27_0.png" src="../../../_images/morph_27_0.png" />
</div>
<figcaption>
<p><span class="caption-number">Fig. 109 </span><span class="caption-text">The effects of thinning and skeletonization on a binary image.</span><a class="headerlink" href="#fig-binary-thinning" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<div class="info admonition">
<p class="admonition-title">What’s the difference between thinning &amp; skeletonization?</p>
<p>The truth is: I’m not entirely sure.
There is quite a bit of overlap in the literature, and I’ve seen the same algorithm referred to by both names.
Furthermore, there are different thinning algorithms that give different results; the situation is similar for skeletonization algorithms.</p>
<p>Software occasionally offers both thinning and skeletonization, but often just offers one or the other.
It’s worth trying any thinning/skeletonization methods available to see which performs best for any particular application.</p>
</div>
</section>
</section>
<section id="morphological-reconstruction">
<h2>Morphological reconstruction<a class="headerlink" href="#morphological-reconstruction" title="Permalink to this headline">#</a></h2>
<p><strong>Morphological reconstruction</strong> is a somewhat advanced technique that underpins several powerful image processing operations.
It’s useful with both grayscale and binary images.</p>
<p>Morphological reconstruction requires two images of the same size: a <strong>marker</strong> image and a <strong>mask</strong> image.
The pixel in the <em>mask</em> image should all have values greater than or equal to the corresponding pixels in the <em>marker</em> image.</p>
<p>The reconstruction algorithm progressively <em>dilates</em> the marker image (e.g. applies a 3×3 maximum filter), while constraining the marker to remain ‘within’ the mask; that is, the pixel values in the marker are never allowed to exceed the values in the mask.
This dilation is repeated iteratively until the marker cannot change any further without exceeding the mask.
The output is the new marker image, after all the dilations have been performed.</p>
<p>Some examples will help demonstrate how this works and why it’s useful.
The crucial difference in the methods below is how the marker and mask images are created.</p>
<section id="hysteresis-thresholding">
<h3>Hysteresis thresholding<a class="headerlink" href="#hysteresis-thresholding" title="Permalink to this headline">#</a></h3>
<p>One use of morphological reconstruction is to implement a <strong>double threshold</strong>, also known as <strong>hysteresis thresholding</strong>.</p>
<aside class="margin sidebar">
<p class="sidebar-title"></p>
<p>For <em>low threshold</em> and <em>high threshold</em>, I assume we’re detecting light structures on a dark background.</p>
</aside>
<p>This involves defining both a <strong>low threshold</strong> and a <strong>high threshold.</strong>
The low threshold operates like any <a class="reference internal" href="../3-thresholding/thresholding.html#chap-thresholding"><span class="std std-ref">global threshold</span></a> to identify regions.
However, a region is discarded from the binary image if it does not also contain at least one pixel that exceeds the high threshold.</p>
<p>This is achieved using morphological reconstruction by defining the <em>marker</em> as all pixels exceeding the high threshold, and the <em>mask</em> as all pixels exceeding the low threshold.
The markers will expand to fill the mask regions that contain them.
But any mask regions that don’t contain marker pixels are simply ignored.</p>
<div class="cell tag_hide-cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from skimage import morphology as morph

# Load image &amp; process
im = load_spots()
bw_low = im &gt; im.mean() + im.std()
bw_high = im &gt; im.mean() + 3 * im.std()
bw_hist = morph.reconstruction(bw_high, bw_low)

# Show original concatenated with the filtered images
fig = create_figure(figsize=(8, 8))

show_image(im, clip_percentile=0.5, title=&quot;(A) Grayscale image&quot;, pos=221)
show_image(bw_low, title=&quot;(B) Mask image (low threshold)&quot;, pos=222)
show_image(bw_high, title=f&quot;(C) Marker image (high threshold)&quot;, pos=223)
show_image(bw_hist, title=f&quot;(D) Reconstruction result (hysteresis threshold)&quot;, pos=224)
plt.tight_layout()

glue_fig(&#39;fig_hysteresis_threshold_spots&#39;, fig)
</pre></div>
</div>
</div>
</div>
<figure class="align-center" id="fig-hysteresis-threshold-spots">
<div class="cell_output docutils container">
<img alt="../../../_images/morph_30_0.png" src="../../../_images/morph_30_0.png" />
</div>
<figcaption>
<p><span class="caption-number">Fig. 110 </span><span class="caption-text">Applying a hysteresis threshold to an image. The size and area of the objects detected by this method are determined by the low threshold, but at least one of the pixel values within the object must exceed the high threshold. This slightly mitigates the problem of a single global threshold having <a class="reference internal" href="../3-thresholding/thresholding.html#chap-thresholding"><span class="std std-ref">a huge impact on analysis results</span></a>, by the same threshold simultaneously influencing both what is detected and its size.</span><a class="headerlink" href="#fig-hysteresis-threshold-spots" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="h-maxima-h-minima">
<span id="sec-h-extrema"></span><h3>H-Maxima &amp; H-Minima<a class="headerlink" href="#h-maxima-h-minima" title="Permalink to this headline">#</a></h3>
<p>We <a class="reference internal" href="#fig-morph-simple-maxima"><span class="std std-ref">saw previously</span></a> that we could (kind of) identify local maxima in a very simple way using an image dilation, but the results are often too inaccurate to be useful.</p>
<p><strong>H-Maxima</strong> and <strong>H-Minima</strong> can help us overcome this.
These operations both require only one intuitive parameter: they enable us to identify maxima or minima using a local intensity threshold <em>H</em>.</p>
<p>This is achieved using morphological reconstruction.
For H-maxima, the process is:</p>
<ul class="simple">
<li><p>Set the original grayscale image as the <em>mask</em></p></li>
<li><p>Subtract <em>H</em> from the mask to create the <em>markers</em></p></li>
<li><p>Apply morphological reconstruction using the markers and mask</p></li>
<li><p>Subtract the reconstruction result from the <em>mask</em></p></li>
<li><p>Threshold the subtracted image with a global threshold of <em>H</em></p></li>
</ul>
<p>The main steps are illustrated in <a class="reference internal" href="#fig-morph-h-maxima"><span class="std std-numref">Fig. 111</span></a>.
We can apply the same process to an inverted image to find <em>H-minima</em>.</p>
<div class="cell tag_hide-cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from skimage import morphology as morph
from skimage import filters as filters
from skimage.segmentation import mark_boundaries

# Load image &amp; process
im = load_spots()
h = im.std()
im_recon = morph.reconstruction(im - h, im)

bw = morph.h_maxima(im, h)
im2 = im - np.percentile(im.ravel(), 0.5)
im2 = im2 / np.percentile(im2.ravel(), 99.5)
im_boundaries = mark_boundaries(np.clip(im2, 0, 1), bw, color=(1, 0, 0))

# Show original concatenated with the filtered images
fig = create_figure(figsize=(8, 8))

show_image(im, clip_percentile=0.5, title=&quot;(A) Grayscale image&quot;, pos=221)
show_image(im_recon, clip_percentile=0.5, title=f&quot;(B) Morphological reconstruction result&quot;, pos=222)
show_image(im - im_recon, clip_percentile=0.5, title=f&quot;(C) Result of (A) - (B)&quot;, pos=223)
show_image(im_boundaries, title=f&quot;(C) H-maxima as an overlay&quot;, pos=224)
plt.tight_layout()

glue_fig(&#39;fig_morph_h_maxima&#39;, fig)
</pre></div>
</div>
</div>
</div>
<figure class="align-center" id="fig-morph-h-maxima">
<div class="cell_output docutils container">
<img alt="../../../_images/morph_33_0.png" src="../../../_images/morph_33_0.png" />
</div>
<figcaption>
<p><span class="caption-number">Fig. 111 </span><span class="caption-text">Calculating H-maxima using morphological reconstruction. Here, <em>H</em> is set (arbitrarily) to be the image standard deviation.</span><a class="headerlink" href="#fig-morph-h-maxima" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="opening-closing-by-reconstruction">
<h3>Opening &amp; closing by reconstruction<a class="headerlink" href="#opening-closing-by-reconstruction" title="Permalink to this headline">#</a></h3>
<p>H-maxima and H-minima use morphological reconstruction to effectively generate a background image that can be subtracted from the original.
We do this by subtracting a constant <em>H</em>, which acts as a local intensity threshold.</p>
<p>We can also use morphological reconstruction to generate a background image based upon spatial information, rather than an intensity threshold <em>H</em>, by using <strong>opening by reconstruction</strong>.
This effectively introduces a size component into our local threshold.
<strong>Closing by reconstruction</strong> is an analogous operation that can be defined using morphological closing.</p>
<p>The starting point for opening by reconstruction is a <em>morphological opening</em> <a class="reference internal" href="#sec-morph-opening-closing"><span class="std std-ref">as defined above</span></a>, i.e. an erosion followed by a dilation.
This defines the marker image.
The original image is used as the mask.</p>
<div class="cell tag_hide-cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from skimage import morphology as morph

radius = 10

# Load image &amp; process
im = load_spots()
im_open = morph.opening(im, morph.disk(radius))
im_recon = morph.reconstruction(im_open, im)

# Show original concatenated with the filtered images
fig = create_figure(figsize=(8, 8))

show_image(im, clip_percentile=0.5, title=&quot;(A) Grayscale image&quot;, pos=221)
show_image(im_open, clip_percentile=0.5, title=f&quot;(B) Morphological opening (radius={radius})&quot;, pos=222)
show_image(im_recon, clip_percentile=0.5, title=f&quot;(C) Opening by reconstruction (radius={radius})&quot;, pos=223)
show_image(im - im_recon, clip_percentile=0.5, title=f&quot;(D) Result of (A) - (C)&quot;, pos=224)
plt.tight_layout()

glue_fig(&#39;fig_morph_reconstruct_opening&#39;, fig)
</pre></div>
</div>
</div>
</div>
<figure class="align-center" id="fig-morph-reconstruct-opening">
<div class="cell_output docutils container">
<img alt="../../../_images/morph_36_0.png" src="../../../_images/morph_36_0.png" />
</div>
<figcaption>
<p><span class="caption-number">Fig. 112 </span><span class="caption-text">Using opening by reconstruction to obtain a background estimate. The estimate can be subtracted from an image before applying a global threshold.</span><a class="headerlink" href="#fig-morph-reconstruct-opening" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>As before, opening alone removes structures that are smaller than the structuring element, while slightly affecting the shapes of everything else.
Opening by reconstruction essentially adds some further (constrained) dilations so that the structures that were <em>not</em> removed are more similar to how they were originally.
This can make opening by reconstruction more attractive for generating background images that will be used for subtraction.</p>
<p>Opening by reconstruction can also be applied to binary images as an alternative to <em>opening</em> and <em>area opening</em>.
Like area opening, opening by reconstruction is able to remove some objects while retaining the shapes of larger objects exactly.</p>
<div class="cell tag_hide-cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from skimage import morphology as morph

radius = 3

# Load image &amp; process
bw = load_binary_spots()
bw_open = morph.opening(bw, morph.disk(radius))
bw_opening_by_recon = morph.reconstruction(bw_open, bw)

# Show original concatenated with the filtered images
fig = create_figure(figsize=(8, 8))

show_image(bw, title=&quot;(A) Binary image&quot;, pos=131)
show_image(bw_open, title=f&quot;(B) Morphological opening (radius={radius})&quot;, pos=132)
show_image(bw_opening_by_recon, title=f&quot;(C) Opening by reconstruction (radius={radius})&quot;, pos=133)
plt.tight_layout()

glue_fig(&#39;fig_morph_reconstruct_opening_binary&#39;, fig)
</pre></div>
</div>
</div>
</div>
<figure class="align-center" id="fig-morph-reconstruct-opening-binary">
<div class="cell_output docutils container">
<img alt="../../../_images/morph_38_0.png" src="../../../_images/morph_38_0.png" />
</div>
<figcaption>
<p><span class="caption-number">Fig. 113 </span><span class="caption-text">Using opening by reconstruction to remove small (and thin) objects from a binary image, while retaining the original shape of everything that remains.</span><a class="headerlink" href="#fig-morph-reconstruct-opening-binary" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</section>
</section>
<div class="toctree-wrapper compound">
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "bioimagebook/bioimagebook.github.io",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./chapters/2-processing/5-morph"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="../4-filters/imagej.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">ImageJ: Filters</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="imagej.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">ImageJ: Morphological operations</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Pete Bankhead<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>